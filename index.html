<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MegaTools Diagnostic Database Viewer</title>
    <!-- Load Tailwind CSS for simple styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Light, clean background */
        }
        .data-table-container {
            max-height: 60vh; /* Set a max height for the table */
            overflow-y: auto; /* Enable vertical scrolling */
        }
        /* Custom scrollbar for aesthetics */
        .data-table-container::-webkit-scrollbar {
            width: 8px;
        }
        .data-table-container::-webkit-scrollbar-thumb {
            background-color: #60a5fa; /* Blue scrollbar for brand matching */
            border-radius: 4px;
        }
        /* Style for pre-formatted instructions */
        .instructions-cell {
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-8">

    <div class="max-w-4xl w-full bg-white shadow-xl rounded-xl p-6 md:p-10 border-t-4 border-blue-600">
        
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
            MegaTools Diagnostic Instructions
        </h1>
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="text-center py-8 text-blue-600 font-semibold hidden">
            Loading Data... Please wait.
        </div>

        <!-- Search and Filter Controls -->
        <div id="search-controls" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 hidden">
            <div>
                <label for="car-brand" class="block text-sm font-medium text-gray-700">Car Brand</label>
                <input type="text" id="car-brand" placeholder="e.g., MERCEDES-BENZ" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="ecu" class="block text-sm font-medium text-gray-700">ECU / System</label>
                <input type="text" id="ecu" placeholder="e.g., EZS or TCM" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="dtc" class="block text-sm font-medium text-gray-700">DTC Code / Function</label>
                <input type="text" id="dtc" placeholder="e.g., P0171 or DEACTIVATION" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <!-- Data Table Display -->
        <div id="data-table-container" class="data-table-container shadow-inner rounded-lg border border-gray-200">
            <table id="data-table" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-blue-100 sticky top-0">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider">Brand</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider">Model</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider">ECU</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider">Function / DTC</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider">Instructions</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="bg-white divide-y divide-gray-100">
                    <!-- Data rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Error Message - Hidden now that data is hardcoded -->
        <div id="error-message" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>

        <button onclick="window.open('https://megatools-lb.com', '_self')"
            class="mt-8 w-full bg-blue-600 text-white py-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
            Go Back to Main Website (megatools-lb.com)
        </button>
    </div>

    <script>
        // --- DATA INPUT SECTION (FULL DATA CONTENT) ---
        // The data is now stored directly as a multi-line CSV string.
        const rawCSVData = `
MERCEDES-BENZ,W205,,EZS,DEACTIVATION OF SOS,"STEP 1- EZS ECU\nSTEP 2- SETTINGS CHANGEOVER\nSTEP 3- DEACTIVATION OF SOS\nSTEP 4- FROM JA TO NEIN"
MERCEDES-BENZ,,,"TCM \n\nVGS-NAG2\nVGS2-NAG2\nVGS3-NAG2","TCM ERASURE FOR : \n\nVGS-NAG2\nVGS2-NAG2\nVGS3-NAG2","STEP 1- MERCEDES-BENZ\nSTEP 2- THEFT PROTECTION\nSTEP 3- EXPERT MODE\nSTEP  4- CONNECT T NINJA BOX\nSTEP 5- TCU\nSTEP 6- CHOOSE RELEVANT TCU (VGS-NAG2/VGS2-NAG2/VGS3-NAG2)\nSTEP 7- WIRING DIAGRAM\nSTEP 8- COMPLETELY ERASE MODULE"
`;


        // --- DATA PROCESSING LOGIC ---
        // Defines the fixed header mapping for the CSV parser
        const csvHeaders = [
            'CAR BRAND', 
            'CAR MODEL', 
            'DTC', 
            'ECU', 
            'DIAGNOSTIC FUNCTION', 
            'INSTRUCTIONS'
        ];

        // Utility to parse CSV text into an array of objects
        function parseCSVToObjects(csvText, headers) {
            const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');

            if (lines.length === 0) return [];
            
            const splitLine = (line) => {
                // Regex to split by comma, but ignore commas inside double quotes
                const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
                return line.split(regex).map(cell => cell.trim());
            };
            
            const data = [];
            const sanitizedHeaders = headers.map(header => 
                header.toUpperCase().replace(/[^A-Z]/g, '')
            );

            lines.forEach(line => {
                const values = splitLine(line);
                
                // Skip rows that don't look like data (e.g., if they are shorter than expected)
                if (values.length < headers.length) {
                    return;
                }

                let obj = {};
                for (let j = 0; j < headers.length; j++) {
                    // Clean up quotes and newlines from quoted cells
                    // The .replace(/\\n/g, '\n') part handles literal \n sequences inside quoted CSV cells.
                    let value = values[j] ? values[j].replace(/^"|"$/g, '').replace(/\\n/g, '\n') : '';
                    
                    // Map the value to the sanitized header key
                    obj[sanitizedHeaders[j]] = value;
                }
                data.push(obj);
            });
            return data;
        }

        // --- GLOBAL VARIABLES & INITIALIZATION ---
        let allData = [];
        const loadingIndicator = document.getElementById('loading-indicator');
        const searchControls = document.getElementById('search-controls');
        const tableBody = document.getElementById('table-body');

        // Helper function to show/hide elements
        const toggleVisibility = (element, show) => element.classList.toggle('hidden', !show);

        // Renders the data into the HTML table
        function renderTable(data) {
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-4 text-center text-gray-500">
                            No results found. Try adjusting your filters.
                        </td>
                    </tr>
                `;
                return;
            }

            data.forEach(item => {
                // Determine what to display for the Function / DTC column
                const functionOrDTC = (item.DIAGNOSTICFUNCTION && item.DIAGNOSTICFUNCTION.trim() !== '') ? item.DIAGNOSTICFUNCTION : (item.DTC || '-');
                
                // Clean up newlines in instructions by replacing them with a <br> tag for HTML display
                const instructionsHtml = item.INSTRUCTIONS ? item.INSTRUCTIONS.replace(/\n/g, '<br>') : '-';
                
                // Format ECU text for display
                const ecuText = item.ECU ? item.ECU.replace(/\n/g, '<br>') : '-';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-blue-50 transition duration-100';
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${item.CARBRAND || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${item.CARMODEL || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 instructions-cell">${ecuText}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 instructions-cell">
                        <span class="block font-semibold text-gray-800">${functionOrDTC}</span>
                        <span class="block text-xs text-red-500">${item.DTC && item.DTC.trim() !== '' ? `DTC: ${item.DTC}` : ''}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700 max-w-sm instructions-cell">${instructionsHtml}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Filters the data based on input fields
        function filterData() {
            const brandFilter = document.getElementById('car-brand').value.toUpperCase();
            const ecuFilter = document.getElementById('ecu').value.toUpperCase();
            const dtcFilter = document.getElementById('dtc').value.toUpperCase();

            const filtered = allData.filter(item => {
                const carBrand = (item.CARBRAND || '').toUpperCase();
                const ecu = (item.ECU || '').toUpperCase();
                
                const brandMatch = !brandFilter || carBrand.includes(brandFilter);
                const ecuMatch = !ecuFilter || ecu.includes(ecuFilter);
                
                // Match DTC filter against both the DTC column and the Diagnostic Function column for robustness
                const dtcOrFunctionText = `${item.DTC || ''} ${item.DIAGNOSTICFUNCTION || ''}`.toUpperCase();
                const dtcMatch = !dtcFilter || dtcOrFunctionText.includes(dtcFilter);
                
                return brandMatch && ecuMatch && dtcMatch;
            });

            renderTable(filtered);
        }

        // Add event listeners to filter inputs
        document.getElementById('car-brand').addEventListener('input', filterData);
        document.getElementById('ecu').addEventListener('input', filterData);
        document.getElementById('dtc').addEventListener('input', filterData);


        // Load static data on window load
        window.onload = function() {
            // Parse the hardcoded CSV data
            allData = parseCSVToObjects(rawCSVData, csvHeaders);
            
            // Render the data immediately
            renderTable(allData);
            
            // Hide the loading indicator and show the search controls
            toggleVisibility(loadingIndicator, false);
            toggleVisibility(searchControls, true);
        };
    </script>
</body>
</html>
